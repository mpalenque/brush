<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Control Panel - Multi-Screen Wallpaper</title>
    
    <!-- Estilos -->
    <link rel="stylesheet" href="assets/css/control.css">
    

</head>
<body>
    <div class="container">
        <h1>🎨 Multi-Screen Wallpaper Control</h1>
        
        <!-- Estado de Conexión -->
        <div class="connection-status" id="connectionStatus">
            🔌 Conectando al servidor...
        </div>

        <!-- Configuración General -->
        <div class="section">
            <h2>⚙️ Configuración General</h2>
            <div class="control-group" style="margin-bottom:12px;">
                <label>🧩 Fuente del Patrón (pantallas):</label>
                <div class="image-buttons">
                    <button class="image-btn pattern-source-btn selected" data-source="processed">🧪 Procesado (P)</button>
                </div>
                <small style="color:#666;">Las pantallas cargarán desde la imagen procesada.</small>
            </div>
            
            <div class="control-group" style="margin-bottom:12px;">
                <label>🎨 Rotación Automática Brush Reveal:</label>
                <div class="auto-rotation-controls">
                    <button id="autoRotationBtn" class="image-btn" data-active="false">
                        � Auto-Rotación OFF
                    </button>
                    <div class="rotation-status" id="rotationStatus" style="margin-top: 8px; font-size: 12px; color: #666;">
                        Rotación desactivada
                    </div>
                </div>
                <small style="color:#666;">Cada 1 minuto cambia entre amarillo.jpg, rojo.jpg, azul.jpg para colorear encima en Brush Reveal.</small>
            </div>
            <div class="controls-grid">
                <div class="control-group">
                    <label for="patternType">🎨 Tipo de Patrón:</label>
                    <select id="patternType">
                        <option value="organic-complex">Orgánico Complejo</option>
                        <option value="grid">Cuadrícula</option>
                        <option value="brick">Ladrillo</option>
                        <option value="hexagon">Hexágono</option>
                        <option value="diamond">Diamante</option>
                        <option value="mirror-horizontal">Espejo Horizontal</option>
                        <option value="mirror-vertical">Espejo Vertical</option>
                        <option value="mirror-both">Espejo Ambos</option>
                        <option value="rotate-90">Rotación 90°</option>
                        <option value="rotate-180">Rotación 180°</option>
                        <option value="rotate-mixed">Rotación Mixta</option>
                        <option value="scale-varied">Escala Variada</option>
                        <option value="alternating-scale">Escala Alternada</option>
                    </select>
                </div>

                <div class="control-group">
                    <label for="repetitionX">🔄 Repeticiones X: <span id="repetitionXValue" class="range-display">200</span></label>
                    <input type="range" id="repetitionX" min="1" max="500" value="200">
                </div>

                <div class="control-group">
                    <label for="repetitionY">🔄 Repeticiones Y: <span id="repetitionYValue" class="range-display">8</span></label>
                    <input type="range" id="repetitionY" min="1" max="25" value="8">
                </div>

                <div class="control-group">
                    <label for="separationX">↔️ Separación X: <span id="separationXValue" class="range-display">300px</span></label>
                    <input type="range" id="separationX" min="50" max="1000" value="300">
                </div>

                <div class="control-group">
                    <label for="separationY">↕️ Separación Y: <span id="separationYValue" class="range-display">300px</span></label>
                    <input type="range" id="separationY" min="50" max="1000" value="300">
                </div>

                <div class="control-group">
                    <label for="spacingX">📏 Espaciado Patrón X: <span id="spacingXValue" class="range-display">0px</span></label>
                    <input type="range" id="spacingX" min="0" max="500" value="0">
                </div>

                <div class="control-group">
                    <label for="spacingY">📏 Espaciado Patrón Y: <span id="spacingYValue" class="range-display">0px</span></label>
                    <input type="range" id="spacingY" min="0" max="500" value="0">
                </div>

                <div class="control-group">
                    <label for="patternSize">📏 Tamaño del Patrón: <span id="sizeValue" class="range-display">300px</span></label>
                    <input type="range" id="patternSize" min="50" max="1000" value="300">
                </div>

                <div class="control-group">
                    <label for="rotation">🔄 Rotación: <span id="rotationValue" class="range-display">0°</span></label>
                    <input type="range" id="rotation" min="0" max="360" value="0">
                </div>

                <div class="control-group">
                    <label for="zoom">🔍 Zoom: <span id="zoomValue" class="range-display">230%</span></label>
                    <input type="range" id="zoom" min="0.5" max="5" step="0.1" value="2.3">
                </div>

                <div class="control-group">
                    <label for="perfumeSpacingH">↔️ Espaciado H Perfume: <span id="perfumeSpacingHValue" class="range-display">0.45×</span></label>
                    <input type="range" id="perfumeSpacingH" min="0.1" max="2.0" step="0.05" value="0.45">
                </div>

                <div class="control-group">
                    <label for="perfumeSpacingV">↕️ Espaciado V Perfume: <span id="perfumeSpacingVValue" class="range-display">0.70×</span></label>
                    <input type="range" id="perfumeSpacingV" min="0.1" max="2.0" step="0.05" value="0.7">
                </div>

                <div class="control-group">
                    <label for="perfumeSizeFactor">📐 Tamaño Perfume: <span id="perfumeSizeFactorValue" class="range-display">85%</span></label>
                    <input type="range" id="perfumeSizeFactor" min="0.3" max="2.0" step="0.05" value="0.85">
                </div>

                <div class="control-group">
                    <label for="backgroundColor">🎨 Color de Fondo: <span id="backgroundRgb" class="range-display">RGB: 245, 221, 199</span></label>
                    <input type="color" id="backgroundColor" value="#F5DDC7">
                </div>
            </div>
        </div>

        <!-- Control de Imágenes Superpuestas -->
        <div class="section">
            <h2>🖼️ Control de Imágenes Superpuestas</h2>
            <p style="margin-bottom: 15px; color: #666; font-size: 14px;">
                Controla la cantidad, posición y tamaño de las imágenes superpuestas (blue.png, red.png, pink.png) que se muestran encima del patrón.
            </p>
            <div class="controls-grid">
                <div class="control-group">
                    <label for="overlayCountX">🔢 Cantidad X: <span id="overlayCountXValue" class="range-display">3</span></label>
                    <input type="range" id="overlayCountX" min="1" max="10" value="3">
                </div>

                <div class="control-group">
                    <label for="overlayCountY">🔢 Cantidad Y: <span id="overlayCountYValue" class="range-display">2</span></label>
                    <input type="range" id="overlayCountY" min="1" max="8" value="2">
                </div>

                <div class="control-group">
                    <label for="overlayOffsetX">↔️ Offset X: <span id="overlayOffsetXValue" class="range-display">0px</span></label>
                    <input type="range" id="overlayOffsetX" min="-2000" max="2000" value="0" step="50">
                </div>

                <div class="control-group">
                    <label for="overlayOffsetY">↕️ Offset Y: <span id="overlayOffsetYValue" class="range-display">0px</span></label>
                    <input type="range" id="overlayOffsetY" min="-2000" max="2000" value="0" step="50">
                </div>

                <div class="control-group">
                    <label for="overlaySize">📏 Tamaño: <span id="overlaySizeValue" class="range-display">200px</span></label>
                    <input type="range" id="overlaySize" min="50" max="500" value="200">
                </div>

                <div class="control-group">
                    <label for="overlaySpacingX">↔️ Espaciado X: <span id="overlaySpacingXValue" class="range-display">800px</span></label>
                    <input type="range" id="overlaySpacingX" min="200" max="2000" value="800" step="50">
                </div>

                <div class="control-group">
                    <label for="overlaySpacingY">↕️ Espaciado Y: <span id="overlaySpacingYValue" class="range-display">600px</span></label>
                    <input type="range" id="overlaySpacingY" min="200" max="1500" value="600" step="50">
                </div>

                <div class="control-group">
                    <label for="overlayRowOffsetX">🔀 Desfase Filas X: <span id="overlayRowOffsetXValue" class="range-display">0px</span></label>
                    <input type="range" id="overlayRowOffsetX" min="-500" max="500" value="0" step="10">
                </div>

                <div class="control-group">
                    <label for="overlayRowOffsetY">🔀 Desfase Filas Y: <span id="overlayRowOffsetYValue" class="range-display">0px</span></label>
                    <input type="range" id="overlayRowOffsetY" min="-500" max="500" value="0" step="10">
                </div>

                <div class="control-group">
                    <label for="overlayColOffsetX">🔀 Desfase Columnas X: <span id="overlayColOffsetXValue" class="range-display">0px</span></label>
                    <input type="range" id="overlayColOffsetX" min="-500" max="500" value="0" step="10">
                </div>

                <div class="control-group">
                    <label for="overlayColOffsetY">🔀 Desfase Columnas Y: <span id="overlayColOffsetYValue" class="range-display">0px</span></label>
                    <input type="range" id="overlayColOffsetY" min="-500" max="500" value="0" step="10">
                </div>

                <div class="control-group">
                    <label for="overlayAlternateRowX">🔄 Filas Alternas X: <span id="overlayAlternateRowXValue" class="range-display">0px</span></label>
                    <input type="range" id="overlayAlternateRowX" min="-1000" max="1000" value="0" step="10">
                </div>

                <div class="control-group">
                    <label for="overlayAlternateRowY">🔄 Filas Alternas Y: <span id="overlayAlternateRowYValue" class="range-display">0px</span></label>
                    <input type="range" id="overlayAlternateRowY" min="-1000" max="1000" value="0" step="10">
                </div>

                <div class="control-group">
                    <label for="overlayAlternateColX">🔄 Columnas Alternas X: <span id="overlayAlternateColXValue" class="range-display">0px</span></label>
                    <input type="range" id="overlayAlternateColX" min="-1000" max="1000" value="0" step="10">
                </div>

                <div class="control-group">
                    <label for="overlayAlternateColY">🔄 Columnas Alternas Y: <span id="overlayAlternateColYValue" class="range-display">0px</span></label>
                    <input type="range" id="overlayAlternateColY" min="-1000" max="1000" value="0" step="10">
                </div>

                <div class="control-group">
                    <label>🎨 Seleccionar Imagen:</label>
                    <div class="image-buttons">
                        <button class="image-btn overlay-image-btn selected" data-image="red">🔴 Roja</button>
                        <button class="image-btn overlay-image-btn" data-image="blue">🔵 Azul</button>
                        <button class="image-btn overlay-image-btn" data-image="pink">🩷 Rosa</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Control de Offsets de Pantallas -->
        <div class="section">
            <h2>🖥️ Ajuste Manual de Offsets</h2>
            <p style="margin-bottom: 15px; color: #666; font-size: 14px;">
                Ajusta manualmente el offset horizontal de cada pantalla. 
                Los valores negativos mueven el patrón hacia la izquierda.
            </p>
            <div class="screens-offset-grid" id="offsetControls">
                <!-- Controles de offset para cada pantalla -->
                <div class="offset-control-group">
                    <label>🖥️ Pantalla 1:</label>
                    <input type="range" id="offset1" min="-5000" max="5000" value="0" step="10">
                    <span id="offset1Value" class="offset-value">0px</span>
                </div>
                <div class="offset-control-group">
                    <label>🖥️ Pantalla 2:</label>
                    <input type="range" id="offset2" min="-5000" max="5000" value="0" step="10">
                    <span id="offset2Value" class="offset-value">0px</span>
                </div>
                <div class="offset-control-group">
                    <label>🖥️ Pantalla 3:</label>
                    <input type="range" id="offset3" min="-5000" max="5000" value="0" step="10">
                    <span id="offset3Value" class="offset-value">0px</span>
                </div>
                <div class="offset-control-group">
                    <label>🖥️ Pantalla 4:</label>
                    <input type="range" id="offset4" min="-5000" max="5000" value="0" step="10">
                    <span id="offset4Value" class="offset-value">0px</span>
                </div>
                <div class="offset-control-group">
                    <label>🖥️ Pantalla 5:</label>
                    <input type="range" id="offset5" min="-5000" max="5000" value="0" step="10">
                    <span id="offset5Value" class="offset-value">0px</span>
                </div>
                <div class="offset-control-group">
                    <label>🖥️ Pantalla 6:</label>
                    <input type="range" id="offset6" min="-5000" max="5000" value="0" step="10">
                    <span id="offset6Value" class="offset-value">0px</span>
                </div>
                <div class="offset-control-group">
                    <label>🖥️ Pantalla 7:</label>
                    <input type="range" id="offset7" min="-5000" max="5000" value="0" step="10">
                    <span id="offset7Value" class="offset-value">0px</span>
                </div>
                <div class="offset-control-group">
                    <label>🖥️ Pantalla 8:</label>
                    <input type="range" id="offset8" min="-5000" max="5000" value="0" step="10">
                    <span id="offset8Value" class="offset-value">0px</span>
                </div>
                <div class="offset-control-group">
                    <label>🖥️ Pantalla 9:</label>
                    <input type="range" id="offset9" min="-5000" max="5000" value="0" step="10">
                    <span id="offset9Value" class="offset-value">0px</span>
                </div>
            </div>
            <div class="offset-buttons" style="margin-top: 15px;">
                <button onclick="zeroAllOffsets()" style="background-color: #dc3545; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer;">
                    ❌ Poner Todos en 0
                </button>
            </div>
        </div>

        <!-- Configuración Brush Reveal -->
        <div class="section">
            <h2>🎨 Configuración Brush Reveal (Secciones Wallpaper)</h2>
            <p style="color: #666; margin-bottom: 15px;">
                Controla las secciones del wallpaper.jpg (6480x3840) que usa cada brush-reveal.<br>
                Cada sección es de 2160x3840 pixels. Accede a: /brush-reveal/1, /brush-reveal/2, etc.
            </p>
            <div class="offset-grid">
                <div class="offset-control-group">
                    <label>🎨 Brush 1 - Offset X:</label>
                    <input type="range" id="brushOffset1X" min="0" max="4320" value="0" step="2160">
                    <span id="brushOffset1XValue" class="offset-value">0px</span>
                </div>
                <div class="offset-control-group">
                    <label>🎨 Brush 2 - Offset X:</label>
                    <input type="range" id="brushOffset2X" min="0" max="4320" value="2160" step="2160">
                    <span id="brushOffset2XValue" class="offset-value">2160px</span>
                </div>
                <div class="offset-control-group">
                    <label>🎨 Brush 3 - Offset X:</label>
                    <input type="range" id="brushOffset3X" min="0" max="4320" value="4320" step="2160">
                    <span id="brushOffset3XValue" class="offset-value">4320px</span>
                </div>
                <div class="offset-control-group">
                    <label>🎨 Brush 4 - Offset X:</label>
                    <input type="range" id="brushOffset4X" min="0" max="4320" value="0" step="2160">
                    <span id="brushOffset4XValue" class="offset-value">0px</span>
                </div>
                <div class="offset-control-group">
                    <label>🎨 Brush 5 - Offset X:</label>
                    <input type="range" id="brushOffset5X" min="0" max="4320" value="2160" step="2160">
                    <span id="brushOffset5XValue" class="offset-value">2160px</span>
                </div>
                <div class="offset-control-group">
                    <label>🎨 Brush 6 - Offset X:</label>
                    <input type="range" id="brushOffset6X" min="0" max="4320" value="4320" step="2160">
                    <span id="brushOffset6XValue" class="offset-value">4320px</span>
                </div>
                <div class="offset-control-group">
                    <label>🎨 Brush 7 - Offset X:</label>
                    <input type="range" id="brushOffset7X" min="0" max="4320" value="0" step="2160">
                    <span id="brushOffset7XValue" class="offset-value">0px</span>
                </div>
                <div class="offset-control-group">
                    <label>🎨 Brush 8 - Offset X:</label>
                    <input type="range" id="brushOffset8X" min="0" max="4320" value="2160" step="2160">
                    <span id="brushOffset8XValue" class="offset-value">2160px</span>
                </div>
                <div class="offset-control-group">
                    <label>🎨 Brush 9 - Offset X:</label>
                    <input type="range" id="brushOffset9X" min="0" max="4320" value="4320" step="2160">
                    <span id="brushOffset9XValue" class="offset-value">4320px</span>
                </div>
            </div>
            <div class="offset-buttons" style="margin-top: 15px;">
                <button onclick="openAllBrushReveals()" style="background-color: #6f42c1; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; margin-right: 10px;">
                    🎨 Abrir Todos los Brush Reveals
                </button>
                <button onclick="resetBrushOffsets()" style="background-color: #dc3545; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer;">
                    ↺ Resetear Offsets
                </button>
            </div>
        </div>

        <!-- Configuración Slideshow -->
        <div class="section">
            <h2>📺 Configuración Slideshow (Brush 3 y 7)</h2>
            <p style="color: #666; margin-bottom: 15px;">
                Control del slideshow superpuesto en brush-reveal/3 y brush-reveal/7.<br>
                Las imágenes se cargan desde las carpetas slideshow/3 y slideshow/4 respectivamente.
            </p>
            
            <!-- Slideshow para Brush 3 -->
            <div class="slideshow-config">
                <h3>📺 Slideshow Brush 3 (Carpeta: slideshow/3)</h3>
                <div class="controls-grid">
                    <div class="control-group">
                        <label>
                            <input type="checkbox" id="slideshow3Enabled"> Activar Slideshow Brush 3
                        </label>
                    </div>
                    <div class="control-group">
                        <label for="slideshow3Width">Ancho: <span id="slideshow3WidthValue" class="range-display">200px</span></label>
                        <input type="range" id="slideshow3Width" min="50" max="500" value="200">
                    </div>
                    <div class="control-group">
                        <label for="slideshow3Height">Alto: <span id="slideshow3HeightValue" class="range-display">200px</span></label>
                        <input type="range" id="slideshow3Height" min="50" max="500" value="200">
                    </div>
                    <div class="control-group">
                        <label for="slideshow3X">Posición X: <span id="slideshow3XValue" class="range-display">50px</span></label>
                        <input type="range" id="slideshow3X" min="0" max="1000" value="50">
                    </div>
                    <div class="control-group">
                        <label for="slideshow3Y">Posición Y: <span id="slideshow3YValue" class="range-display">50px</span></label>
                        <input type="range" id="slideshow3Y" min="0" max="1000" value="50">
                    </div>
                    <div class="control-group">
                        <label for="slideshow3Interval">Intervalo: <span id="slideshow3IntervalValue" class="range-display">3000ms</span></label>
                        <input type="range" id="slideshow3Interval" min="1000" max="10000" value="3000" step="500">
                    </div>
                </div>
            </div>

            <!-- Slideshow para Brush 7 -->
            <div class="slideshow-config" style="margin-top: 20px;">
                <h3>📺 Slideshow Brush 7 (Carpeta: slideshow/4)</h3>
                <div class="controls-grid">
                    <div class="control-group">
                        <label>
                            <input type="checkbox" id="slideshow7Enabled"> Activar Slideshow Brush 7
                        </label>
                    </div>
                    <div class="control-group">
                        <label for="slideshow7Width">Ancho: <span id="slideshow7WidthValue" class="range-display">200px</span></label>
                        <input type="range" id="slideshow7Width" min="50" max="500" value="200">
                    </div>
                    <div class="control-group">
                        <label for="slideshow7Height">Alto: <span id="slideshow7HeightValue" class="range-display">200px</span></label>
                        <input type="range" id="slideshow7Height" min="50" max="500" value="200">
                    </div>
                    <div class="control-group">
                        <label for="slideshow7X">Posición X: <span id="slideshow7XValue" class="range-display">50px</span></label>
                        <input type="range" id="slideshow7X" min="0" max="1000" value="50">
                    </div>
                    <div class="control-group">
                        <label for="slideshow7Y">Posición Y: <span id="slideshow7YValue" class="range-display">50px</span></label>
                        <input type="range" id="slideshow7Y" min="0" max="1000" value="50">
                    </div>
                    <div class="control-group">
                        <label for="slideshow7Interval">Intervalo: <span id="slideshow7IntervalValue" class="range-display">3000ms</span></label>
                        <input type="range" id="slideshow7Interval" min="1000" max="10000" value="3000" step="500">
                    </div>
                </div>
            </div>
        </div>

        <!-- Abrir Pantallas -->
        <div class="section">
            <h2>🚀 Abrir Pantallas en Nuevas Pestañas</h2>
            <div class="screens-grid-3x3" id="screensGrid">
                <!-- Las pantallas se generarán dinámicamente en grilla 3x3 -->
            </div>
            <div style="margin-top: 15px;">
                <button onclick="openAllScreens()" style="background-color: #28a745; font-size: 16px; font-weight: bold; width: 100%; padding: 15px; border: none; border-radius: 5px; color: white; cursor: pointer;">
                    🖥️ Abrir TODAS las Pantallas (1-9)
                </button>
            </div>
            <div style="margin-top: 10px;">
                <button onclick="openBrushReveal()" style="background-color: #6f42c1; font-size: 16px; font-weight: bold; width: 100%; padding: 15px; border: none; border-radius: 5px; color: white; cursor: pointer;">
                    🎨 Abrir Brush Reveal
                </button>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="/socket.io/socket.io.js"></script>
    <script>
        // Sistema de conexión mejorado - sin reloads constantes
        let connectionCheckCount = 0;
        let maxDisconnectionChecks = 3;
        
        function ensureControlConnection() {
            if (!window.socket) {
                // Socket aún no inicializado
                return;
            }
            
            if (window.socket.disconnected) {
                connectionCheckCount++;
                console.log(`⚠️ Control: Conexión perdida (${connectionCheckCount}/${maxDisconnectionChecks})`);
                
                // Solo recargar después de múltiples checks fallidos
                if (connectionCheckCount >= maxDisconnectionChecks) {
                    console.log('🔄 Control: Reconectando después de múltiples intentos fallidos...');
                    location.reload();
                }
            } else {
                connectionCheckCount = 0;
                console.log('✅ Control: Conexión al servidor activa');
            }
        }
        
        // Verificar conexión cada 10 segundos (menos frecuente)
        const connectionCheckInterval = setInterval(ensureControlConnection, 10000);
        
        // Sistema de rotación automática de imágenes para Brush Reveal
        let autoRotationActive = false;
        let rotationInterval = null;
        let currentRotationIndex = 0;
        const rotationImages = ['amarillo', 'rojo', 'azul'];
        
        function toggleAutoRotation() {
            const btn = document.getElementById('autoRotationBtn');
            const status = document.getElementById('rotationStatus');
            
            autoRotationActive = !autoRotationActive;
            
            if (autoRotationActive) {
                btn.textContent = '🔄 Auto-Rotación ON';
                btn.style.backgroundColor = '#28a745';
                btn.style.color = 'white';
                btn.setAttribute('data-active', 'true');
                
                // Iniciar rotación inmediatamente
                rotateToNextImage();
                
                // Configurar intervalo de 1 minuto (60000 ms) para testing
                rotationInterval = setInterval(rotateToNextImage, 60000);
                
                updateRotationStatus();
                console.log('🎨 Auto-rotación activada - rotando cada 1 minuto entre:', rotationImages);
            } else {
                btn.textContent = '🔄 Auto-Rotación OFF';
                btn.style.backgroundColor = '';
                btn.style.color = '';
                btn.setAttribute('data-active', 'false');
                
                if (rotationInterval) {
                    clearInterval(rotationInterval);
                    rotationInterval = null;
                }
                
                status.textContent = 'Rotación desactivada';
                console.log('🛑 Auto-rotación desactivada');
            }
        }
        
        function rotateToNextImage() {
            const currentImage = rotationImages[currentRotationIndex];
            console.log(`🎨 Rotando a imagen: ${currentImage}.jpg`);
            console.log(`📡 Socket conectado:`, window.socket && window.socket.connected);
            
            // Enviar comando al brush-reveal para que use esta nueva imagen
            if (window.socket && window.socket.connected) {
                const payload = { 
                    imageName: `${currentImage}.jpg`,
                    imageType: currentImage 
                };
                window.socket.emit('brushRevealRotateImage', payload);
                console.log(`📡 Enviado comando brush-reveal:`, payload);
            } else {
                console.error('❌ Socket no conectado - no se puede enviar comando');
            }
            
            // Avanzar al siguiente índice
            currentRotationIndex = (currentRotationIndex + 1) % rotationImages.length;
            
            updateRotationStatus();
        }
        
        function updateRotationStatus() {
            const status = document.getElementById('rotationStatus');
            if (autoRotationActive) {
                const currentImage = rotationImages[(currentRotationIndex - 1 + rotationImages.length) % rotationImages.length];
                const nextImage = rotationImages[currentRotationIndex];
                status.innerHTML = `Activa • Actual: <strong>${currentImage}.jpg</strong> • Próxima: <strong>${nextImage}.jpg</strong> (en 1 min)`;
            }
        }
        
        // Agregar event listener al botón cuando el DOM esté listo
        document.addEventListener('DOMContentLoaded', function() {
            const autoRotationBtn = document.getElementById('autoRotationBtn');
            if (autoRotationBtn) {
                autoRotationBtn.addEventListener('click', toggleAutoRotation);
            }
            
            // Inicializar controles de slideshow
            initializeSlideshowControls();
        });
        
        // NUEVO: Manejador de tecla 'a' para capturar wallpaper
        document.addEventListener('keydown', (e) => {
            if (e.key === 'a' || e.key === 'A') {
                e.preventDefault();
                console.log('📸 Tecla A presionada - solicitando captura de canvas...');
                
                if (window.socket && window.socket.connected) {
                    // Solicitar a screen.html que capture y envíe el canvas
                    window.socket.emit('requestCanvasCapture');
                    console.log('📡 Solicitud de captura enviada a screen.html');
                    
                    // Mostrar feedback visual
                    const feedback = document.createElement('div');
                    feedback.style.cssText = `
                        position: fixed;
                        top: 20px;
                        right: 20px;
                        background: #28a745;
                        color: white;
                        padding: 15px 20px;
                        border-radius: 8px;
                        z-index: 10000;
                        font-weight: bold;
                        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                    `;
                    feedback.textContent = '📸 Capturando wallpaper...';
                    document.body.appendChild(feedback);
                    
                    setTimeout(() => {
                        if (feedback.parentNode) {
                            feedback.remove();
                        }
                    }, 3000);
                } else {
                    console.error('❌ Socket no conectado - no se puede solicitar captura');
                }
            }
        });
        
        // Limpiar interval al cerrar
        window.addEventListener('beforeunload', () => {
            if (connectionCheckInterval) clearInterval(connectionCheckInterval);
            if (rotationInterval) clearInterval(rotationInterval);
        });

        // ==============================
        // SLIDESHOW CONTROLS
        // ==============================

        function initializeSlideshowControls() {
            // Slideshow Brush 3
            setupSlideshowControls(3, 'slideshow/3');
            
            // Slideshow Brush 7 
            setupSlideshowControls(7, 'slideshow/4');
        }

        function setupSlideshowControls(brushId, folder) {
            const enabled = document.getElementById(`slideshow${brushId}Enabled`);
            const width = document.getElementById(`slideshow${brushId}Width`);
            const height = document.getElementById(`slideshow${brushId}Height`);
            const x = document.getElementById(`slideshow${brushId}X`);
            const y = document.getElementById(`slideshow${brushId}Y`);
            const interval = document.getElementById(`slideshow${brushId}Interval`);

            // Event listeners para actualizar valores en tiempo real
            enabled.addEventListener('change', () => updateSlideshowConfig(brushId));
            width.addEventListener('input', (e) => {
                document.getElementById(`slideshow${brushId}WidthValue`).textContent = e.target.value + 'px';
                updateSlideshowConfig(brushId);
            });
            height.addEventListener('input', (e) => {
                document.getElementById(`slideshow${brushId}HeightValue`).textContent = e.target.value + 'px';
                updateSlideshowConfig(brushId);
            });
            x.addEventListener('input', (e) => {
                document.getElementById(`slideshow${brushId}XValue`).textContent = e.target.value + 'px';
                updateSlideshowConfig(brushId);
            });
            y.addEventListener('input', (e) => {
                document.getElementById(`slideshow${brushId}YValue`).textContent = e.target.value + 'px';
                updateSlideshowConfig(brushId);
            });
            interval.addEventListener('input', (e) => {
                document.getElementById(`slideshow${brushId}IntervalValue`).textContent = e.target.value + 'ms';
                updateSlideshowConfig(brushId);
            });
        }

        function updateSlideshowConfig(brushId) {
            const config = {
                enabled: document.getElementById(`slideshow${brushId}Enabled`).checked,
                width: parseInt(document.getElementById(`slideshow${brushId}Width`).value),
                height: parseInt(document.getElementById(`slideshow${brushId}Height`).value),
                x: parseInt(document.getElementById(`slideshow${brushId}X`).value),
                y: parseInt(document.getElementById(`slideshow${brushId}Y`).value),
                interval: parseInt(document.getElementById(`slideshow${brushId}Interval`).value),
                folder: brushId === 3 ? '3' : '4'
            };

            // Enviar configuración al servidor
            fetch(`/api/slideshow/${brushId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(config)
            })
            .then(response => response.json())
            .then(data => {
                console.log(`📺 Configuración de slideshow ${brushId} actualizada:`, config);
            })
            .catch(error => {
                console.error('Error actualizando slideshow:', error);
            });
        }
    </script>
    <script src="assets/js/control.js"></script>
</body>
</html>
