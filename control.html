<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Control Panel - Multi-Screen Wallpaper</title>
    
    <!-- Estilos -->
    <link rel="stylesheet" href="assets/css/control.css">
    
    <!-- OpenCV.js Configuration -->
    <script>
        // Configuración global para OpenCV
        function updateOpenCVStatus(message, type = 'normal') {
            const statusDiv = document.getElementById('opencvStatus');
            if (statusDiv) {
                statusDiv.textContent = message;
                statusDiv.className = `opencv-status ${type}`;
            }
        }
        
        function onOpenCvReady() {
            console.log('OpenCV.js is ready!');
            // La lógica principal está en opencv-processor.js
            if (window.onOpenCvReady) {
                window.onOpenCvReady();
            }
        }
    </script>
</head>
<body>
    <div class="container">
        <h1>🎨 Multi-Screen Wallpaper Control</h1>
        
        <!-- Estado de Conexión -->
        <div class="connection-status" id="connectionStatus">
            🔌 Conectando al servidor...
        </div>

        <!-- Sección OpenCV -->
        <div class="section opencv-section">
            <h2>📷 OpenCV - Detección y Corrección de Perspectiva de Rectángulos</h2>
            
            <div id="opencvStatus" class="opencv-status">
                ⏳ Cargando OpenCV.js...
            </div>
            
            <div class="opencv-controls">
                <div class="opencv-input-area">
                    <h3>📤 Carga de Imagen</h3>
                    <div class="image-upload" onclick="document.getElementById('imageInput').click()">
                        <p>📁 Haz clic aquí o arrastra una imagen</p>
                        <p>Formatos: JPG, PNG, WebP</p>
                        <input type="file" id="imageInput" accept="image/*">
                    </div>
                    
                    <img id="imagePreview" class="image-preview" style="display: none;" alt="Vista previa">
                    
                    <div class="control-group">
                        <label for="thresholdValue">🎯 Umbral de Detección: <span id="thresholdDisplay" class="range-display">200</span></label>
                        <input type="range" id="thresholdValue" min="50" max="255" value="200">
                    </div>
                    
                    <div class="control-group">
                        <label for="minAreaValue">📏 Área Mínima: <span id="minAreaDisplay" class="range-display">1000</span></label>
                        <input type="range" id="minAreaValue" min="500" max="5000" value="1000">
                    </div>
                    
                    <div class="control-group">
                        <label for="epsilonValue">🔧 Precisión Epsilon: <span id="epsilonDisplay" class="range-display">0.020</span></label>
                        <input type="range" id="epsilonValue" min="0.005" max="0.1" step="0.005" value="0.02">
                    </div>
                    
                    <div class="control-group">
                        <label for="aspectRatioTolerance">📐 Tolerancia Aspecto: <span id="aspectRatioDisplay" class="range-display">2.0</span></label>
                        <input type="range" id="aspectRatioTolerance" min="1.0" max="5.0" step="0.1" value="2.0">
                    </div>
                    
                    <button id="processButton" class="process-button" onclick="detectWhiteRectangleSimple()" disabled>
                        🔍 Detectar y Corregir Rectángulo
                    </button>
                    
                    <button id="autoProcessButton" class="process-button" onclick="autoProcessAndApply()" disabled>
                        🚀 PROCESO AUTOMÁTICO COMPLETO
                    </button>
                </div>
                
                <div class="opencv-output-area">
                    <h3>📊 Resultados</h3>
                    
                    <div class="result-container">
                        <h4>🎯 Detección</h4>
                        <canvas id="detectionCanvas"></canvas>
                    </div>
                    
                    <div class="result-container">
                        <h4>✅ Imagen Corregida</h4>
                        <canvas id="correctedCanvas"></canvas>
                    </div>
                    
                    <button id="downloadButton" class="process-button" style="background: linear-gradient(45deg, #4CAF50, #45a049);">
                        💾 Descargar Imagen Corregida
                    </button>
                </div>
            </div>
        </div>

        <!-- Configuración General -->
        <div class="section">
            <h2>⚙️ Configuración General</h2>
            <div class="controls-grid">
                <div class="control-group">
                    <label for="patternType">🎨 Tipo de Patrón:</label>
                    <select id="patternType">
                        <option value="organic-complex">Orgánico Complejo</option>
                        <option value="grid">Cuadrícula</option>
                        <option value="brick">Ladrillo</option>
                        <option value="hexagon">Hexágono</option>
                        <option value="diamond">Diamante</option>
                        <option value="mirror-horizontal">Espejo Horizontal</option>
                        <option value="mirror-vertical">Espejo Vertical</option>
                        <option value="mirror-both">Espejo Ambos</option>
                        <option value="rotate-90">Rotación 90°</option>
                        <option value="rotate-180">Rotación 180°</option>
                        <option value="rotate-mixed">Rotación Mixta</option>
                        <option value="scale-varied">Escala Variada</option>
                        <option value="alternating-scale">Escala Alternada</option>
                    </select>
                </div>

                <div class="control-group">
                    <label for="repetitionX">🔄 Repeticiones X: <span id="repetitionXValue" class="range-display">13</span></label>
                    <input type="range" id="repetitionX" min="1" max="30" value="13">
                </div>

                <div class="control-group">
                    <label for="repetitionY">🔄 Repeticiones Y: <span id="repetitionYValue" class="range-display">12</span></label>
                    <input type="range" id="repetitionY" min="1" max="25" value="12">
                </div>

                <div class="control-group">
                    <label for="patternSize">📏 Tamaño del Patrón: <span id="sizeValue" class="range-display">300px</span></label>
                    <input type="range" id="patternSize" min="50" max="500" value="300">
                </div>

                <div class="control-group">
                    <label for="rotation">🔄 Rotación: <span id="rotationValue" class="range-display">0°</span></label>
                    <input type="range" id="rotation" min="0" max="360" value="0">
                </div>

                <div class="control-group">
                    <label for="zoom">🔍 Zoom: <span id="zoomValue" class="range-display">230%</span></label>
                    <input type="range" id="zoom" min="0.5" max="5" step="0.1" value="2.3">
                </div>

                <div class="control-group">
                    <label for="perfumeSpacingH">↔️ Espaciado H Perfume: <span id="perfumeSpacingHValue" class="range-display">0.45×</span></label>
                    <input type="range" id="perfumeSpacingH" min="0.1" max="2.0" step="0.05" value="0.45">
                </div>

                <div class="control-group">
                    <label for="perfumeSpacingV">↕️ Espaciado V Perfume: <span id="perfumeSpacingVValue" class="range-display">0.70×</span></label>
                    <input type="range" id="perfumeSpacingV" min="0.1" max="2.0" step="0.05" value="0.7">
                </div>

                <div class="control-group">
                    <label for="perfumeSizeFactor">📐 Tamaño Perfume: <span id="perfumeSizeFactorValue" class="range-display">85%</span></label>
                    <input type="range" id="perfumeSizeFactor" min="0.3" max="2.0" step="0.05" value="0.85">
                </div>

                <div class="control-group">
                    <label for="backgroundColor">🎨 Color de Fondo: <span id="backgroundRgb" class="range-display">RGB: 245, 221, 199</span></label>
                    <input type="color" id="backgroundColor" value="#F5DDC7">
                </div>
            </div>
        </div>

        <!-- Control de Wallpaper -->
        <div class="section">
            <h2>🎬 Control de Wallpaper</h2>
            <div class="controls-grid">
                <div class="control-group">
                    <button id="toggleWallpaper" class="wallpaper-on">
                        🟢 Encender Wallpaper + Animación
                    </button>
                </div>
                <div class="control-group">
                    <button id="savePattern">
                        💾 Guardar Patrón como Imagen
                    </button>
                </div>
            </div>
            <div class="propagation-info">
                <h4>📈 Patrón de Propagación Orgánica:</h4>
                <p>La animación inicia en la esquina inferior izquierda (Pantalla 1) y se propaga orgánicamente:</p>
                <div class="timing-sequence">
                    Pantalla 1 → 4 → 2 → 7 → 5 → 3 → 8 → 6 → 9<br>
                    (0ms → 250ms → 350ms → 500ms → 600ms → 700ms → 850ms → 950ms → 1100ms)
                </div>
            </div>
        </div>

        <!-- Abrir Pantallas -->
        <div class="section">
            <h2>🚀 Abrir Pantallas en Nuevas Pestañas</h2>
            <div class="screens-grid" id="screensGrid">
                <!-- Las pantallas se generarán dinámicamente -->
            </div>
            <div style="margin-top: 15px;">
                <button onclick="openAllScreens()" style="background-color: #28a745; font-size: 16px; font-weight: bold; width: 100%; padding: 15px; border: none; border-radius: 5px; color: white; cursor: pointer;">
                    🖥️ Abrir TODAS las Pantallas (1-9)
                </button>
            </div>
            <div style="margin-top: 10px;">
                <button onclick="openBrushReveal()" style="background-color: #6f42c1; font-size: 16px; font-weight: bold; width: 100%; padding: 15px; border: none; border-radius: 5px; color: white; cursor: pointer;">
                    🎨 Abrir Brush Reveal
                </button>
            </div>
        </div>

        <!-- URLs de Previsualización -->
        <div class="preview-urls">
            <h3>🔗 URLs de las Pantallas:</h3>
            <div class="url-list" id="urlList">
                <!-- Las URLs se generarán dinámicamente -->
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="/socket.io/socket.io.js"></script>
    <script src="assets/js/opencv-processor.js"></script>
    <script src="assets/js/control.js"></script>
    
    <!-- Download button handler -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const downloadButton = document.getElementById('downloadButton');
            if (downloadButton) {
                downloadButton.addEventListener('click', function() {
                    const canvas = document.getElementById('correctedCanvas');
                    if (canvas) {
                        const link = document.createElement('a');
                        link.download = 'rectangulo_corregido.png';
                        link.href = canvas.toDataURL();
                        link.click();
                    }
                });
            }
        });
    </script>
</body>
</html>
